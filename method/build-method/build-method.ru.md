# Методология сборки БЭМ-проекта

Компонентный подход в БЭМ-методологии определяет структуру проекта в файловой системе. Интерфейс разделяется на отдельные компоненты — блоки. Каждый компонент располагается в своей директории. Поэтому для получения рабочего БЭМ-проекта необходима сборка.

Сборка решает следующие задачи:
* собирает отдельные [файлы реализаций](../filesystem/filesystem.ru.md#Реализация-блока-разделяется-на-отдельные-файлы), разложенные по файловой системе;
* включает в сборку только нужные [блоки](../key-concepts/key-concepts.ru.md#Блок), [элементы](../key-concepts/key-concepts.ru.md#Элемент) и [модификаторы](../key-concepts/key-concepts.ru.md#Модификатор) из имеющихся в проекте;
* учитывает порядок подключения файлов в сборку.

Рассмотрим организацию файловой структуры БЭМ-проекта.

Блоки могут быть реализованы в одной или нескольких [технологиях](../key-concepts/key-concepts.ru.md#Технология-реализации). Каждая технология реализации находятся в отдельном файле. [Реализация](../key-concepts/key-concepts.ru.md#Реализация-блока) блока, элемента или модификатора может быть дополнительно разделена по [уровням переопределения](../key-concepts/key-concepts.ru.md#Уровень-переопределения).

Например:

```files
blocks/                 # Уровень проекта
    input/              # Директория блока `input`
        input.css       # Реализация блока `input` в технологии CSS
        input.js        # Реализация блока `input` в технологии JavaScript
    icon/
        icon.css

library/                # Уровень библиотеки
    input/
    button/
```

> Подробно о целях разделения блоков на отдельные файлы читайте в документе [Организация файловой системы БЭМ-проекта](../filesystem/filesystem.ru.md).

## Основные этапы сборки

Чтобы из отдельных файлов получить рабочую страницу (результат сборки), необходимо:

* [перечислить блоки, элементы и модификаторы, участвующие в построении страницы](#Перечисление-необходимых-блоков-и-элементов-для-создания-страницы)
* [указать зависимости используемых БЭМ-сущностей](#Поиск-необходимых-зависимостей-используемых-БЭМ-сущностей)
* [собрать исходные файлы](#Определение-порядка-подключения-БЭМ-сущностей-в-сборку)

### Результаты сборки

В результате сборки можно получить разные финальные наборы файлов:

* файлы для отдельной страницы (например, `hello.css` и `hello.js`);
* общие файлы для всего проекта (например, один `project.css` и `project.js` и отдельные шаблоны для каждой страницы);
* файлы для фрагмента страницы (например, `header.css` и `header.js`.) Используются, когда существует общая часть для всех страниц проекта, которая собирается отдельно и подключается при сборке.

Такие наборы файлов, полученные в результате сборки, в БЭМ-методологии принято называть **бандлами**.

> Обратите внимание, в документе сборка рассматривается на примере **страницы** — частного случая бандла.

В файловой системе собранные файлы помещаются в отдельную директорию с названием страницы (например, `hello`):

```files
blocks/                 # Директория, содержащая блоки

bundles/                # Директория, содержащая все результаты сборки
    hello/              # Директория страницы `hello`
```

Пример файловой системы БЭМ-проекта до выполнения сборки:

```files
blocks/                 # Директория, содержащая блоки

bundles/                # Директория, содержащая все результаты сборки
    hello/              # Директория страницы `hello`
        hello.decl.js   # Список БЭМ-сущностей, необходимых для страницы `hello`
```

Пример файловой системы БЭМ-проекта после выполнения сборки:

```files
blocks/                 # Директория, содержащая блоки

bundles/                # Директория, содержащая все результаты сборки
    hello/              # Директория страницы `hello`
        hello.decl.js   # Список БЭМ-сущностей, необходимых для страницы `hello`
        hello.css       # Собранный CSS-файл страницы `hello`
        hello.js        # Собранный JavaScript-файл страницы `hello`
```

При сборке в проект могут быть включены:

* все БЭМ-сущности с файловой системы (что значительно увеличивает объем результирующего кода);
* только необходимые для построения страницы БЭМ-сущности в строго определенном порядке.

Для сборки в проект только нужных БЭМ-сущностей используются (опционально):

* [Декларация](#Определение-списка-блоков-элементов-и-модификаторов-для-создания-страницы) — определяет список БЭМ-сущностей, необходимых для создания страницы.
* [Зависимости](#Поиск-зависимостей) — определяют дополнительные БЭМ-сущности.
* [Уровни переопределения](#Определение-порядка-подключения-БЭМ-сущностей-в-сборку) — определяют порядок подключения БЭМ-сущностей в сборку.

### Определение списка блоков, элементов и модификаторов для создания страницы

Чтобы начать сборку страницы, необходимо узнать, из чего она состоит.

![Декларация](build__declaration.png)

Рассмотрим на примере, для чего формируется список необходимых БЭМ-сущностей.

В проект подключена библиотека, из которой на странице используются несколько блоков. Нет необходимости включать всю библиотеку в сборку. Достаточно составить список нужного по описанию страницы. На основании этого списка в сборку попадут только перечисленные блоки. В БЭМ-методологии такой список называется [декларацией](../declaration/declaration.ru.md).

Основная задача декларации определить, что и в каком порядке подключать в сборку.

Существуют различные [способы построения декларации](../declaration/declaration.ru.md#Способы-управления-декларациями).

### Поиск зависимостей

В БЭМ-методологии многие блоки строятся на основании других блоков. Так, например, блок формы поиска (`search-form`) построен с помощью блоков `input` (поле ввода) и `button` (кнопка). Нет необходимости реализовывать блок повторно, если он уже представлен в библиотеке. Новый блок можно построить на основании существующего.

![Пример составного блока](build__search-form.png)

Для обеспечения взаимосвязи между блоками и их корректной работы необходимо указать зависимости.

Инструмент сборки получает данные о зависимостях и добавляет все сущности и технологии, необходимые для реализации блока, в сборку. В зависимостях также указывается порядок подключения сущностей.

Существует несколько способов указать зависимости:

* Непосредственно в коде блока (in place).

  ```files
  blocks/
      input/
          input.css       # Зависимости в CSS можно определять по `@import`
          input.js        # Зависимости в JavaScript можно декларировать
                          # с помощью модульной системы (например, AMD,
                          # CommonJS) или импортов (ECMAScript 2015)
      button/
          button.css
          button.js
  ```

* В отдельном файле.

  > В БЭМ-платформе для указания зависимостей используется технология [DEPS](https://ru.bem.info/technology/deps/).

  ```files
  blocks/
      input/
          input.css
          input.js
          input.deps.js   # Файл с зависимостями блока `input`
      button/
          button.css
          button.js
  ```

### Определение порядка подключения БЭМ-сущностей в сборку

Порядок подключения БЭМ-сущностей в сборку зависит от:

* **указанных зависимостей**

  Зависимости определяют, когда дополнительная сущность должна попасть в сборку.

* **используемых уровней переопределения**

  Важно соблюдать порядок подключения [уровней](../key-concepts/key-concepts.ru.md#Уровень-переопределения) в сборку. Если сравнить уровни со слоями, то базовый слой – это исходная реализация блока, а каждый последующий слой накладывается сверху и дополняет (наследует) или изменяет базовую реализацию. Поэтому важно, чтобы в сборку сначала попадала исходная реализация, а затем изменения со всех уровней переопределения.

На схеме показан принцип использования уровней переопределения при сборке: с уровня `common` подключаются общие компоненты для всех платформ, а с уровней `desktop` и `touch` — платформо-специфичные компоненты.

![Уровни переопределения](build__levels.png)

Подробно об использовании уровней читайте в примерах:

* [Переопределение блоков библиотеки](../filesystem/filesystem.ru.md#Подключение-библиотеки)
* [Разделение проекта на платформы](../filesystem/filesystem.ru.md#Разделение-проекта-на-платформы)

## Инструменты для сборки

Выбор инструмента для сборки зависит от сложности БЭМ-проекта, наличия в нем уровней переопределения и использования зависимостей.

БЭМ-методология не ограничивает выбор инструмента — можно использовать любые сборщики (например, Gulp, Grunt, Brunch, Broccoli), отвечающие требованиям вашего проекта.

> Пример сборки БЭМ-проекта с помощью [Gulp](http://gulpjs.com/) — [Декларативный JavaScript по БЭМ](https://ru.bem.info/events/beminar-july-2015/).

В БЭМ-платформе используется сборщик [ENB](https://ru.bem.info/tools/bem/enb-bem/), который подходит для сборки БЭМ-проектов любой сложности.

> Пример сборки БЭМ-проекта с помощью [ENB](https://ru.bem.info/tools/bem/enb-bem/) — [Создаем свой проект на БЭМ](https://ru.bem.info/tutorials/start-with-project-stub/).
