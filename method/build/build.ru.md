# Сборка БЭМ-проекта

Проекты, построенные по БЭМ-методологии, имеют разветвленную файловую структуру. Причина — реализация [блоков](../key-concepts/key-concepts.ru.md#Блок) в БЭМ делится на независимые [файлы-технологии](../key-concepts/key-concepts.ru.md#Технология-реализации).

Пример организации файловой структуры БЭМ-проекта:

```files
blocks/                 # Уровень проекта
    input/              # Директория блока `input`
        input.css       # Реализация блока `input` в технологии CSS
        input.js        # Реализация блока `input` в технологии JavaScript
    icon/
        icon.css

library/                # Уровень библиотеки
    input/
        input.js        # Базовая реализация блока `input` в технологии JavaScript
    button/
```

Чтобы получить из отдельных файлов-технологий общие файлы для всего проекта используется сборка. Для этого можно применить любой из [инструментов](#Инструменты-для-сборки).

> Подробнее о том, зачем разделять реализацию блока на отдельные файлы читайте в разделе [Организация файловой структуры БЭМ-проекта](../filestructure/filestructure.ru.md).

Сборка решает следующие задачи:

* объединяет отдельные [файлы-технологии](../filestructure/filestructure.ru.md#Реализация-блока-разделяется-на-отдельные-файлы), разложенные по файловой структуре проекта;
* подключает в проект только нужные блоки, [элементы](../key-concepts/key-concepts.ru.md#Элемент) и [модификаторы](../key-concepts/key-concepts.ru.md#Модификатор);
* учитывает порядок подключения файлов в проект.

## Этапы сборки

Чтобы из отдельных файлов получить готовый проект ([результат сборки](#Результат-сборки)), например, веб-страницу, необходимо:

1. [Определить список БЭМ-сущностей для страницы](#Определение-списка-БЭМ-сущностей-для-страницы).
2. [Описать зависимости между ними](#Описание-зависимостей).
3. [Определить порядок их подключения](#Определение-порядка-подключения-БЭМ-сущностей-в-сборку).

### Определение списка БЭМ-сущностей для страницы

Список [БЭМ-сущностей](../key-concepts/key-concepts.ru.md#БЭМ-сущность) используемых на странице называется [декларацией](../declarations/declarations.ru.md). Инструмент сборки, основываясь на данных из декларации, ограничивает количество сущностей, попадающих в проект.

Задача декларации определить, что и в каком порядке подключать в финальный набор файлов (`project.css`, `project.js`, `project.bemhtml`, ...), полученных в результате сборки. Ниже приведен пример сборки БЭМ-проекта.

**Пример**

![Сборка БЭМ-проекта](https://rawgit.com/bem-site/bem-method/godfreyd-methodology-deps/method/build/build__declaration.svg)

В данном примере в проект (Source files) подключена библиотека, из которой на странице используются три блока (`button`, `input`, `langswitch`). Не обязательно включать в сборку всю библиотеку. Достаточно составить список (Declaration) БЭМ-сущностей, используемых на странице. На основании этого списка в финальный файл (`project.css`) попадут только перечисленные блоки.

> Подробнее о [способах построения декларации](../declarations/declarations.ru.md#Способы-получения-декларации).

### Описание зависимостей

В БЭМ-методологии многие блоки строятся на основании других блоков. Для явного указания зависимостей от иных БЭМ-сущностей и технологий используются файлы-технологии [deps.js](https://ru.bem.info/technology/deps/). В качестве примера рассмотрим форму поиска (`search-form`) построенную с помощью блоков `input` (поле ввода) и `button` (кнопка).

**Пример**

![Пример составного блока](https://rawgit.com/bem-site/bem-method/godfreyd-methodology-deps/method/build/build__search-form.svg)

Не обязательно реализовывать кнопку и поле ввода повторно, если они уже представлены в библиотеке. Блок `search-form` можно построить на их основе. Для этого необходимо указать зависимости от блоков `input` и `button`.

Инструмент сборки получает данные о зависимостях и добавляет все блоки, элементы, модификаторы и технологии, необходимые для реализации блока. В зависимостях также определяется [порядок подключения БЭМ-сущностей в сборку](#Определение-порядка-подключения-БЭМ-сущностей-в-сборку).

Способы указания зависимостей:

* В коде блока.

  * В CSS зависимости можно определять с помощью директивы [@import](http://htmlbook.ru/css/import).
  * В JavaScript зависимости описываются с помощью модульной системы (например, [AMD](https://github.com/amdjs/amdjs-api/wiki/AMD), [CommonJS](http://www.commonjs.org/)) или импортов ([ECMAScript 2015](http://ecmascript.org)).

* В отдельном файле.

  В БЭМ-платформе для указания зависимостей используется технология DEPS.

  **Пример**

  ```files
  blocks/
      search-form/
          search-form.css
          search-form.deps.js   # Файл с зависимостями блока `search-form`

  ```

### Определение порядка подключения БЭМ-сущностей в сборку

Порядок подключения БЭМ-сущностей в сборку зависит от:

* **Указанных зависимостей**.

  [Определяют](https://ru.bem.info/platform/deps/#Синтаксис-depsjs), в каком порядке блоки, элементы и модификаторы должна попасть в сборку.

* **Используемых уровней переопределения**.

  Позволяют изменять представление и поведение блоков для различных платформ.

  Рассмотрим пример:

  ![Уровни переопределения](https://rawgit.com/bem-site/bem-method/godfreyd-methodology-deps/method/build/build__levels.svg)

  С уровня `common` подключаются общие компоненты для всех платформ, а с уровней `desktop` и `touch` — компоненты, специфичные для каждой из платформ.

  Поэтому важно, чтобы сначала в сборку попадала исходная реализация, а затем изменения со всех [уровней переопределения](../key-concepts/key-concepts.ru.md#Уровень-переопределения).

  Подробно об использовании уровней переопределения читайте в примерах:

  * [Переопределение блоков библиотеки](../filestructure/filestructure.ru.md#Подключение-библиотеки)
  * [Разделение проекта на платформы](../filestructure/filestructure.ru.md#Разделение-проекта-на-платформы)

## Результат сборки

В результате сборки, основываясь на данных из [декларации](../declarations/declarations.ru.md), можно получить разные финальные наборы файлов:

* файлы для фрагмента страницы (например, `header.css` или `footer.css`);
* файлы для отдельной страницы (например, `hello.css` и `hello.js`);
* файлы для всего проекта (например, `project.css` и `project.js`).

Такие наборы файлов, полученные в результате сборки, в БЭМ-методологии принято называть **бандлами**. В качестве примера рассмотрим сборку страницы `hello`.

**Пример**

Файловая структура БЭМ-проекта до выполнения сборки:

```files
blocks/                 # Директория, содержащая блоки

bundles/                # Директория, содержащая результаты сборки (опционально)
    hello/              # Директория страницы `hello` (создается вручную)
        hello.decl.js   # Список БЭМ-сущностей, необходимых для страницы `hello`
```

Файловая структура БЭМ-проекта после выполнения сборки:

```files
blocks/                 

bundles/                
    hello/              
        hello.decl.js   
        hello.css       # Собранный CSS-файл страницы `hello`
        hello.js        # Собранный JavaScript-файл страницы `hello`
```

При сборке в проект могут быть включены:

* все БЭМ-сущности с файловой структуры проекта (что значительно увеличивает объем результирующего кода);
* только необходимые для построения страницы БЭМ-сущности в строго определенном порядке.

## Инструменты для сборки

БЭМ-методология не ограничивает выбор инструмента. Можно использовать любые сборщики (например, Gulp, Grunt, Brunch, Broccoli), отвечающие требованиям проекта.

При выборе инструмента для сборки следует руководствоваться:
* сложностью БЭМ-проекта;
* наличием в нем уровней переопределения;
* использованием зависимостей.

> Пример сборки БЭМ-проекта с помощью [Gulp](http://gulpjs.com/) — [Декларативный JavaScript по БЭМ](https://ru.bem.info/forum/-696/).

В БЭМ-платформе используется сборщик [ENB](https://ru.bem.info/tools/bem/enb-bem/), который подходит для сборки БЭМ-проектов любой сложности.

> Пример сборки БЭМ-проекта с помощью [ENB](https://ru.bem.info/tools/bem/enb-bem/) — [Создаем проект по БЭМ](https://ru.bem.info/tutorials/start-with-project-stub/).
